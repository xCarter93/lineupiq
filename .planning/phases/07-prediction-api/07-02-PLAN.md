---
phase: 07-prediction-api
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - packages/backend/src/lineupiq/api/schemas/__init__.py
  - packages/backend/src/lineupiq/api/schemas/prediction.py
  - packages/backend/src/lineupiq/api/routes/__init__.py
  - packages/backend/src/lineupiq/api/routes/predictions.py
  - packages/backend/src/lineupiq/api/main.py
  - packages/backend/tests/test_prediction_endpoints.py
autonomous: true
---

<objective>
Create prediction endpoints for all positions (QB, RB, WR, TE) with proper request/response schemas.

Purpose: Enable predictions by accepting feature values and returning stat predictions for each position. This is the core inference functionality.
Output: Working POST endpoints at /predict/qb, /predict/rb, /predict/wr, /predict/te
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-prediction-api/07-01-SUMMARY.md

# Feature columns for inference
@packages/backend/src/lineupiq/features/pipeline.py

# Model targets by position
# QB: passing_yards, passing_tds
# RB: rushing_yards, rushing_tds, carries, receiving_yards, receptions
# WR: receiving_yards, receiving_tds, receptions
# TE: receiving_yards, receiving_tds, receptions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pydantic schemas for predictions</name>
  <files>packages/backend/src/lineupiq/api/schemas/__init__.py, packages/backend/src/lineupiq/api/schemas/prediction.py</files>
  <action>
Create schemas/ directory with:

1. prediction.py with Pydantic models:

PredictionRequest (base class):
  - All 17 feature fields as floats with Field descriptions:
    - Rolling stats: passing_yards_roll3, passing_tds_roll3, rushing_yards_roll3, rushing_tds_roll3, carries_roll3, receiving_yards_roll3, receiving_tds_roll3, receptions_roll3
    - Opponent: opp_pass_defense_strength, opp_rush_defense_strength, opp_pass_yards_allowed_rank, opp_rush_yards_allowed_rank, opp_total_yards_allowed_rank
    - Weather: temp_normalized, wind_normalized
    - Context: is_home (bool), is_dome (bool)

QBPredictionResponse:
  - passing_yards: float
  - passing_tds: float

RBPredictionResponse:
  - rushing_yards: float
  - rushing_tds: float
  - carries: float
  - receiving_yards: float
  - receptions: float

ReceiverPredictionResponse (for both WR and TE):
  - receiving_yards: float
  - receiving_tds: float
  - receptions: float

2. __init__.py exporting all schemas

Use Pydantic v2 syntax (model_config, Field with examples).
  </action>
  <verify>
cd packages/backend && uv run python -c "from lineupiq.api.schemas import PredictionRequest, QBPredictionResponse; print('Schemas OK')"
  </verify>
  <done>All Pydantic schemas importable</done>
</task>

<task type="auto">
  <name>Task 2: Create prediction routes</name>
  <files>packages/backend/src/lineupiq/api/routes/__init__.py, packages/backend/src/lineupiq/api/routes/predictions.py</files>
  <action>
Create routes/ directory with:

1. predictions.py with APIRouter:

Helper function prepare_features(request: PredictionRequest) -> np.ndarray:
  - Extract feature values in correct order (use get_feature_columns() from lineupiq.features)
  - Handle is_home/is_dome boolean to float conversion
  - Return 2D numpy array shape (1, 17) for single prediction

POST /predict/qb endpoint:
  - Takes PredictionRequest
  - Gets QB models from request.app.state.models using get_position_models()
  - Runs each model.predict(features) for passing_yards and passing_tds
  - Returns QBPredictionResponse

POST /predict/rb endpoint:
  - Same pattern, uses RB models
  - Returns RBPredictionResponse with 5 stat predictions

POST /predict/wr endpoint:
  - Uses WR models
  - Returns ReceiverPredictionResponse

POST /predict/te endpoint:
  - Uses TE models
  - Returns ReceiverPredictionResponse

All endpoints should:
  - Have clear docstrings for OpenAPI docs
  - Use dependency injection for models via Request object
  - Round predictions to 1 decimal place

2. __init__.py exporting router

Import numpy and lineupiq.features.get_feature_columns.
  </action>
  <verify>
cd packages/backend && uv run python -c "from lineupiq.api.routes import router; print(f'{len(router.routes)} routes')"
  </verify>
  <done>Router has 4 prediction routes</done>
</task>

<task type="auto">
  <name>Task 3: Register routes and add endpoint tests</name>
  <files>packages/backend/src/lineupiq/api/main.py, packages/backend/tests/test_prediction_endpoints.py</files>
  <action>
1. Update main.py:
   - Import router from lineupiq.api.routes
   - Add app.include_router(router, prefix="/predict", tags=["predictions"])

2. Create test_prediction_endpoints.py:

test_qb_prediction():
  - POST /predict/qb with sample features
  - Verify 200 response
  - Verify response has passing_yards and passing_tds keys
  - Verify values are reasonable floats (0-500 for yards, 0-8 for TDs)

test_rb_prediction():
  - POST /predict/rb with sample features
  - Verify response has all 5 RB stat keys
  - Verify reasonable ranges

test_wr_prediction() and test_te_prediction():
  - Similar pattern for receiver positions
  - Verify 3 stat keys each

test_invalid_request():
  - POST with missing fields
  - Verify 422 validation error

Use TestClient. Create a fixture with sample_features dict matching PredictionRequest schema.
  </action>
  <verify>cd packages/backend && uv run pytest tests/test_prediction_endpoints.py -v</verify>
  <done>All endpoint tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd packages/backend && uv run uvicorn lineupiq.api.main:app --port 8000` starts
- [ ] `curl -X POST localhost:8000/predict/qb -H "Content-Type: application/json" -d '{"passing_yards_roll3": 250, ...}'` returns predictions
- [ ] `curl localhost:8000/docs` shows OpenAPI docs with all 4 endpoints
- [ ] `cd packages/backend && uv run pytest tests/test_prediction_endpoints.py -v` passes
</verification>

<success_criteria>

- All 4 position endpoints (QB, RB, WR, TE) return predictions
- Request validation works (422 on missing/invalid fields)
- Predictions are reasonable numbers (not NaN or extreme values)
- OpenAPI docs show all endpoints with schemas
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-prediction-api/07-02-SUMMARY.md`
</output>

---
phase: 07-prediction-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/backend/src/lineupiq/api/__init__.py
  - packages/backend/src/lineupiq/api/main.py
  - packages/backend/src/lineupiq/api/models_loader.py
  - packages/backend/tests/test_api_setup.py
autonomous: true
---

<objective>
Create FastAPI application with model loading infrastructure and health endpoint.

Purpose: Establish the API foundation that loads all 13 trained models at startup and keeps them in memory for fast inference. This is the base layer for prediction endpoints.
Output: Working FastAPI app at localhost:8000 with /health endpoint and all models loaded.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Model loading API
@packages/backend/src/lineupiq/models/__init__.py

# Reference for model file naming
# Models are stored as {POSITION}_{target}.joblib (e.g., QB_passing_yards.joblib)
# 13 models total: QB (2), RB (5), WR (3), TE (3)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API package with FastAPI app</name>
  <files>packages/backend/src/lineupiq/api/__init__.py, packages/backend/src/lineupiq/api/main.py</files>
  <action>
Create the api/ directory structure under src/lineupiq/:

1. Create __init__.py with docstring and export `app` from main.py

2. Create main.py with:
   - FastAPI app instance with title="LineupIQ API", version="0.1.0"
   - Lifespan context manager that loads models at startup (using load_models() from models_loader)
   - GET /health endpoint that returns {"status": "healthy", "models_loaded": len(app.state.models)}
   - Store loaded models in app.state.models dict (keyed by model name like "QB_passing_yards")

Do NOT use deprecated @app.on_event("startup") - use lifespan context manager per FastAPI docs.
  </action>
  <verify>
cd packages/backend && uv run python -c "from lineupiq.api import app; print(app.title)"
  </verify>
  <done>FastAPI app importable with title "LineupIQ API"</done>
</task>

<task type="auto">
  <name>Task 2: Create model loader utility</name>
  <files>packages/backend/src/lineupiq/api/models_loader.py</files>
  <action>
Create models_loader.py with:

1. load_models() function that:
   - Uses lineupiq.models.list_models() to get all model names
   - Uses lineupiq.models.load_model(name) to load each model
   - Returns dict[str, Any] mapping model name to loaded XGBoost model
   - Logs count of models loaded
   - Example: {"QB_passing_yards": <xgboost.XGBRegressor>, ...}

2. get_position_models(models: dict, position: str) function that:
   - Filters models dict to only those starting with position prefix
   - Returns dict like {"passing_yards": model, "passing_tds": model}
   - Strips position prefix from keys for cleaner access

Type hints throughout. Import logging for info messages.
  </action>
  <verify>
cd packages/backend && uv run python -c "from lineupiq.api.models_loader import load_models; m = load_models(); print(f'Loaded {len(m)} models')"
  </verify>
  <done>load_models() returns dict with 13 models</done>
</task>

<task type="auto">
  <name>Task 3: Add API setup tests</name>
  <files>packages/backend/tests/test_api_setup.py</files>
  <action>
Create test_api_setup.py with:

1. test_app_exists() - verify FastAPI app imports correctly
2. test_health_endpoint() - use TestClient to GET /health, verify 200 and models_loaded > 0
3. test_load_models() - verify load_models() returns dict with expected model count (13)
4. test_get_position_models() - verify filtering works (QB should have 2 models)

Use fastapi.testclient.TestClient for endpoint tests.
Import from lineupiq.api and lineupiq.api.models_loader.
  </action>
  <verify>cd packages/backend && uv run pytest tests/test_api_setup.py -v</verify>
  <done>All 4 tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd packages/backend && uv run python -c "from lineupiq.api import app"` succeeds
- [ ] `cd packages/backend && uv run uvicorn lineupiq.api.main:app --port 8000` starts server
- [ ] `curl http://localhost:8000/health` returns {"status": "healthy", "models_loaded": 13}
- [ ] `cd packages/backend && uv run pytest tests/test_api_setup.py -v` passes all tests
</verification>

<success_criteria>

- FastAPI app created with lifespan model loading
- 13 models loaded at startup and available in app.state.models
- /health endpoint returns status and model count
- All tests pass
- Server starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-prediction-api/07-01-SUMMARY.md`
</output>

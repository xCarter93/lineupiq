---
phase: 08-convex-backend
plan: 03
type: execute
wave: 2
depends_on: ['08-01']
files_modified:
  - packages/frontend/convex/predictions.ts
  - packages/frontend/convex/players.ts
  - packages/frontend/hooks/usePredictions.ts
  - packages/frontend/hooks/usePlayers.ts
autonomous: true
---

<objective>
Implement prediction storage and player lookup functionality.

Purpose: Store predictions fetched from Python API and provide player search for matchup UI.
Output: Convex queries/mutations and React hooks for predictions and players.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-convex-backend/08-01-SUMMARY.md

# Prediction response shapes from Python API (07-02):

# QB: {passing_yards, passing_tds}

# RB: {rushing_yards, rushing_tds, carries, receiving_yards, receptions}

# WR/TE: {receiving_yards, receiving_tds, receptions}

@packages/frontend/convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Convex functions for predictions</name>
  <files>packages/frontend/convex/predictions.ts</files>
  <action>
    Create convex/predictions.ts with:

    **Queries:**
    1. `getByPlayer` - Get most recent prediction for a player
       - Args: playerId, week (optional), season (optional)
       - If week/season provided, get specific prediction
       - If not, get most recent by createdAt

    2. `getByPlayerWeek` - Get prediction for specific player/week/season
       - Args: playerId, week, season
       - Uses by_player_week index

    3. `listRecent` - Get N most recent predictions
       - Args: limit (default 10)
       - Ordered by createdAt descending

    **Mutations:**
    1. `store` - Store or update a prediction
       - Args: playerId, position, week, season, predictions (object)
       - Check if prediction exists for this player/week/season
       - If exists, update predictions and createdAt
       - If not, insert new document
       - Return prediction _id

    2. `remove` - Delete a prediction
       - Args: id
       - Return void

    3. `clearOld` - Clear predictions older than N days
       - Args: daysOld (default 7)
       - Delete all predictions where createdAt < now - daysOld
       - Return count deleted

    The predictions field uses v.any() to accommodate position-specific shapes.

  </action>
  <verify>
    - `pnpm dlx convex dev` shows functions deployed
    - No TypeScript errors
  </verify>
  <done>All prediction Convex functions deployed</done>
</task>

<task type="auto">
  <name>Task 2: Create Convex functions for players</name>
  <files>packages/frontend/convex/players.ts</files>
  <action>
    Create convex/players.ts with:

    **Queries:**
    1. `list` - Return all players, ordered by name
       - Args: none

    2. `getByPosition` - Get players for a position
       - Args: position ("QB" | "RB" | "WR" | "TE")
       - Uses by_position index

    3. `getByTeam` - Get players on a team
       - Args: team (e.g., "KC", "SF")
       - Uses by_team index

    4. `search` - Search players by name
       - Args: query (string)
       - Filter where name.toLowerCase().includes(query.toLowerCase())
       - Limit to 20 results

    **Mutations:**
    1. `upsert` - Create or update player
       - Args: playerId, name, position, team
       - Check if playerId exists, update or insert
       - Return player _id

    2. `bulkUpsert` - Upsert multiple players
       - Args: players (array of {playerId, name, position, team})
       - Upsert each player
       - Return count upserted

    3. `remove` - Delete player
       - Args: id
       - Return void

    This table will be populated from nflreadpy player data in Phase 9.

  </action>
  <verify>
    - `pnpm dlx convex dev` shows functions deployed
    - No TypeScript errors
  </verify>
  <done>All player Convex functions deployed</done>
</task>

<task type="auto">
  <name>Task 3: Create React hooks for predictions and players</name>
  <files>packages/frontend/hooks/usePredictions.ts, packages/frontend/hooks/usePlayers.ts</files>
  <action>
    1. Create hooks/usePredictions.ts:

    ```tsx
    "use client";
    import { useQuery, useMutation } from "convex/react";
    import { api } from "@/convex/_generated/api";
    import { Id } from "@/convex/_generated/dataModel";

    export function usePrediction(playerId: string, week?: number, season?: number) {
      return useQuery(api.predictions.getByPlayer, { playerId, week, season });
    }

    export function useRecentPredictions(limit = 10) {
      return useQuery(api.predictions.listRecent, { limit });
    }

    export function usePredictionMutations() {
      return {
        store: useMutation(api.predictions.store),
        remove: useMutation(api.predictions.remove),
        clearOld: useMutation(api.predictions.clearOld),
      };
    }
    ```

    2. Create hooks/usePlayers.ts:

    ```tsx
    "use client";
    import { useQuery, useMutation } from "convex/react";
    import { api } from "@/convex/_generated/api";

    export function usePlayers() {
      return useQuery(api.players.list);
    }

    export function usePlayersByPosition(position: "QB" | "RB" | "WR" | "TE") {
      return useQuery(api.players.getByPosition, { position });
    }

    export function usePlayersByTeam(team: string) {
      return useQuery(api.players.getByTeam, { team });
    }

    export function usePlayerSearch(query: string) {
      return useQuery(api.players.search, { query });
    }

    export function usePlayerMutations() {
      return {
        upsert: useMutation(api.players.upsert),
        bulkUpsert: useMutation(api.players.bulkUpsert),
        remove: useMutation(api.players.remove),
      };
    }
    ```

  </action>
  <verify>
    - No TypeScript errors in hooks
    - Imports resolve correctly
  </verify>
  <done>React hooks ready for predictions and players</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm dlx convex dev` shows all prediction and player functions deployed
- [ ] TypeScript compiles without errors
- [ ] React hooks properly typed with Convex generated types
- [ ] Convex dashboard shows predictions and players tables
</verification>

<success_criteria>

- 6 prediction functions (3 queries, 3 mutations)
- 7 player functions (4 queries, 3 mutations)
- React hooks abstract all Convex API calls
- Tables ready for Phase 9 UI integration
  </success_criteria>

<output>
After completion, create `.planning/phases/08-convex-backend/08-03-SUMMARY.md`
</output>

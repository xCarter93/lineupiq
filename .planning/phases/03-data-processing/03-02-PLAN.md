---
phase: 03-data-processing
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - packages/backend/src/lineupiq/data/normalization.py
  - packages/backend/src/lineupiq/data/__init__.py
  - packages/backend/tests/test_normalization.py
autonomous: true
---

<objective>
Create player and team ID normalization module.

Purpose: Ensure consistent identifiers across seasons and datasets. NFL teams have moved/rebranded (e.g., STL->LA, OAK->LV, SD->LAC, WAS rebrands), and player IDs need to be consistent for joins.
Output: normalization.py module with team abbreviation mapping and player ID standardization.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-data-processing/03-01-SUMMARY.md

@packages/backend/src/lineupiq/data/fetchers.py
@packages/backend/src/lineupiq/data/cleaning.py
@packages/backend/src/lineupiq/data/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create team abbreviation normalization</name>
  <files>packages/backend/src/lineupiq/data/normalization.py</files>
  <action>
Create normalization.py module with team normalization:

1. Define TEAM_MAPPING dict for historical team abbreviations to current:
   ```python
   TEAM_MAPPING: dict[str, str] = {
       # Relocations
       "STL": "LA",    # St. Louis Rams -> LA Rams (2016)
       "SD": "LAC",    # San Diego Chargers -> LA Chargers (2017)
       "OAK": "LV",    # Oakland Raiders -> Las Vegas Raiders (2020)
       # Name changes (keep same city)
       "WAS": "WAS",   # Washington (various names, abbreviation consistent)
       # Historical (pre-1999, but in case data has them)
       "PHO": "ARI",   # Phoenix Cardinals -> Arizona Cardinals
   }
   ```

2. Define CURRENT_TEAMS frozenset with all 32 current NFL team abbreviations.

3. `normalize_team(team: str) -> str`:
   - Return TEAM_MAPPING.get(team, team) to handle old names
   - If result not in CURRENT_TEAMS, log warning

4. `normalize_team_columns(df: pl.DataFrame) -> pl.DataFrame`:
   - Apply normalization to common team columns: recent_team, team, home_team, away_team, opponent_team
   - Only modify columns that exist
   - Return modified DataFrame

Use Polars expressions for efficient column transformation.
  </action>
  <verify>cd packages/backend && uv run python -c "from lineupiq.data.normalization import normalize_team, CURRENT_TEAMS; print(normalize_team('OAK'), normalize_team('KC'), len(CURRENT_TEAMS))"</verify>
  <done>normalization.py exists with TEAM_MAPPING, CURRENT_TEAMS, normalize_team, normalize_team_columns</done>
</task>

<task type="auto">
  <name>Task 2: Add player ID and position normalization</name>
  <files>packages/backend/src/lineupiq/data/normalization.py</files>
  <action>
Add player normalization functions to normalization.py:

1. `standardize_player_id(df: pl.DataFrame) -> pl.DataFrame`:
   - Ensure player_id column is string type (some datasets have mixed types)
   - Strip whitespace from player_id
   - Create player_key column: lowercase(player_id) for case-insensitive matching
   - Log any player_id fixes

2. `normalize_position(df: pl.DataFrame) -> pl.DataFrame`:
   - Standardize position values to uppercase: qb -> QB, Rb -> RB
   - Handle edge cases: FB -> RB (fullbacks grouped with RBs for fantasy)
   - Log position normalization stats

3. `normalize_player_data(df: pl.DataFrame) -> pl.DataFrame`:
   - Orchestrator: normalize_team_columns -> standardize_player_id -> normalize_position
   - Returns fully normalized player DataFrame

This enables consistent joins between player_stats and other datasets.
  </action>
  <verify>cd packages/backend && uv run python -c "from lineupiq.data.normalization import normalize_player_data; print('Import OK')"</verify>
  <done>standardize_player_id, normalize_position, and normalize_player_data functions added</done>
</task>

<task type="auto">
  <name>Task 3: Update exports and add tests</name>
  <files>packages/backend/src/lineupiq/data/__init__.py, packages/backend/tests/test_normalization.py</files>
  <action>
1. Update __init__.py to export:
   - TEAM_MAPPING
   - CURRENT_TEAMS
   - normalize_team
   - normalize_team_columns
   - standardize_player_id
   - normalize_position
   - normalize_player_data

2. Create test_normalization.py with tests:
   - test_normalize_team_handles_relocations: OAK -> LV, STL -> LA, SD -> LAC
   - test_normalize_team_preserves_current: KC -> KC, BUF -> BUF
   - test_current_teams_has_32: Verify len(CURRENT_TEAMS) == 32
   - test_normalize_team_columns_applies: Create df with old team names, verify normalized
   - test_standardize_player_id_strips_whitespace: " ABC123 " -> "ABC123"
   - test_normalize_position_uppercase: "qb" -> "QB"
   - test_normalize_position_fb_to_rb: "FB" -> "RB"
   - test_normalize_player_data_full_pipeline: Verify all normalizations applied

Keep tests focused on expected behavior with small test DataFrames.
  </action>
  <verify>cd packages/backend && uv run pytest tests/test_normalization.py -v</verify>
  <done>All exports added and tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd packages/backend && uv run python -c "from lineupiq.data import normalize_player_data, CURRENT_TEAMS"` succeeds
- [ ] `cd packages/backend && uv run pytest tests/test_normalization.py -v` passes all tests
- [ ] len(CURRENT_TEAMS) == 32
- [ ] normalize_team("OAK") == "LV"
</verification>

<success_criteria>
- All tasks completed
- normalization.py module exists with documented functions
- All 32 current NFL teams in CURRENT_TEAMS
- Historical team mappings work correctly
- Tests pass for all normalization functions
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-processing/03-02-SUMMARY.md`
</output>

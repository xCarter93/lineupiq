---
phase: 02-data-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/backend/src/lineupiq/data/__init__.py
  - packages/backend/src/lineupiq/data/fetchers.py
  - packages/backend/tests/test_fetchers.py
autonomous: true
---

<objective>
Create nflreadpy data fetching module with typed functions for player stats, schedules, and other NFL data.

Purpose: Establish clean, typed interface for fetching NFL data that all downstream processing will use.
Output: Data fetcher module with functions for each data type needed for ML training.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-pipeline/DISCOVERY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@packages/backend/src/lineupiq/__init__.py
@packages/backend/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data fetcher module with typed interfaces</name>
  <files>packages/backend/src/lineupiq/data/__init__.py, packages/backend/src/lineupiq/data/fetchers.py</files>
  <action>
Create data subpackage with fetcher functions:

1. Create `packages/backend/src/lineupiq/data/` directory
2. Create `__init__.py` exporting public functions
3. Create `fetchers.py` with:

```python
import polars as pl
from typing import Literal

SeasonList = int | list[int] | bool | None

def fetch_player_stats(
    seasons: SeasonList = None,
    summary_level: Literal["week", "reg", "post", "reg+post"] = "week"
) -> pl.DataFrame:
    """Fetch player statistics from nflreadpy.

    Args:
        seasons: Year(s) to fetch. None=current, True=all, int/list=specific.
        summary_level: Aggregation level (default weekly).

    Returns:
        Polars DataFrame with 114 columns of player stats.
    """

def fetch_schedules(seasons: SeasonList = True) -> pl.DataFrame:
    """Fetch game schedules with weather/venue data."""

def fetch_snap_counts(seasons: SeasonList = None) -> pl.DataFrame:
    """Fetch snap participation data (2012+)."""
```

Key behaviors:
- Return Polars DataFrames (not pandas) - nflreadpy returns Polars natively
- Include docstrings with return type info
- Handle the seasons parameter pattern consistently
- Add basic logging for fetch operations
- Wrap nflreadpy calls with try/except for import errors

Do NOT convert to pandas internally - callers can convert if needed with .to_pandas().
  </action>
  <verify>uv run python -c "from lineupiq.data import fetch_player_stats; print(fetch_player_stats([2024]).shape)"</verify>
  <done>Data module exists with fetch_player_stats, fetch_schedules, fetch_snap_counts functions that return Polars DataFrames</done>
</task>

<task type="auto">
  <name>Task 2: Add position filtering utility</name>
  <files>packages/backend/src/lineupiq/data/fetchers.py, packages/backend/src/lineupiq/data/__init__.py</files>
  <action>
Add utility function for filtering to skill positions (QB, RB, WR, TE):

```python
SKILL_POSITIONS = frozenset({"QB", "RB", "WR", "TE"})

def filter_skill_positions(df: pl.DataFrame) -> pl.DataFrame:
    """Filter DataFrame to skill positions only (QB, RB, WR, TE).

    Args:
        df: DataFrame with 'position' column.

    Returns:
        Filtered DataFrame with only skill position rows.
    """
    return df.filter(pl.col("position").is_in(SKILL_POSITIONS))
```

Export SKILL_POSITIONS and filter_skill_positions from __init__.py.

This supports PROJECT.md requirement: "Position priority: Skill positions (QB, RB, WR, TE) before K/DEF"
  </action>
  <verify>uv run python -c "from lineupiq.data import fetch_player_stats, filter_skill_positions; df = filter_skill_positions(fetch_player_stats([2024])); print(df['position'].unique())"</verify>
  <done>filter_skill_positions function returns only QB, RB, WR, TE rows</done>
</task>

<task type="auto">
  <name>Task 3: Add basic test coverage</name>
  <files>packages/backend/tests/test_fetchers.py</files>
  <action>
Create test file with integration tests that validate fetcher behavior:

```python
import pytest
import polars as pl
from lineupiq.data import (
    fetch_player_stats,
    fetch_schedules,
    fetch_snap_counts,
    filter_skill_positions,
    SKILL_POSITIONS,
)

class TestFetchers:
    """Test data fetcher functions."""

    def test_fetch_player_stats_returns_polars(self):
        """Player stats returns Polars DataFrame."""
        df = fetch_player_stats([2024])
        assert isinstance(df, pl.DataFrame)

    def test_fetch_player_stats_has_expected_columns(self):
        """Player stats has key fantasy columns."""
        df = fetch_player_stats([2024])
        required = {"player_id", "passing_yards", "rushing_yards", "receiving_yards"}
        assert required.issubset(set(df.columns))

    def test_fetch_schedules_has_weather_columns(self):
        """Schedules includes weather data."""
        df = fetch_schedules([2024])
        assert {"temp", "wind", "roof"}.issubset(set(df.columns))

    def test_filter_skill_positions(self):
        """Skill filter returns only QB/RB/WR/TE."""
        df = fetch_player_stats([2024])
        filtered = filter_skill_positions(df)
        positions = set(filtered["position"].unique().to_list())
        assert positions.issubset(SKILL_POSITIONS)
```

Run with: uv run pytest tests/test_fetchers.py -v

Note: These are integration tests that hit the network. Mark as slow if adding to CI later.
  </action>
  <verify>cd packages/backend && uv run pytest tests/test_fetchers.py -v</verify>
  <done>All tests pass, verifying fetchers return correct types and columns</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `from lineupiq.data import fetch_player_stats` works
- [ ] fetch_player_stats returns Polars DataFrame with 114 columns
- [ ] fetch_schedules returns DataFrame with temp, wind, roof columns
- [ ] filter_skill_positions returns only QB, RB, WR, TE
- [ ] All tests in test_fetchers.py pass
</verification>

<success_criteria>
- All tasks completed
- Data fetcher module importable from lineupiq.data
- Functions return typed Polars DataFrames
- Tests verify column presence and types
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-pipeline/02-01-SUMMARY.md`
</output>
